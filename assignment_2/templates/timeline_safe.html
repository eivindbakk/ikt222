{% extends "base.html" %}
{% block content %}
{% if vulnerable %}
<div class="card" style="border:1px solid #ff8a8a; background:linear-gradient(90deg,#2b1212, #201010); color:#ffdcdc; margin-bottom:1rem;">
  <strong>⚠️ Vulnerable view</strong> — this page intentionally renders user input without escaping. Use only for demonstration.
</div>
{% endif %}
<div class="layout">
  <main class="col-main">
    {% if vulnerable %}<h2>Home — Vulnerable feed</h2>
    {% elif following %}<h2>Following</h2>
    {% elif tag %}<h2>#{{ tag }}</h2>
    {% else %}<h2>Home — Safe feed</h2>{% endif %}
    <p class="meta">
      Identical layout; only the rendering is different. •
      <a href="{{ url_for('posts_all') }}">See all posts</a>
    </p>

    {% for p in posts %}
    <div class="card">
      <div class="meta">
        <a href="{{ url_for('profile', username=p.username) }}">@{{ p.username }}</a> • {{ p.created_at }}
      </div>
      <div class="content">{{ p.content_html }}</div>
      {% if p.like_count is defined %}
      <form class="row" method="post" action="{{ url_for('like' if not p.i_like else 'unlike', post_id=p.id) }}" style="margin-top:.5rem">
        <button class="btn secondary" type="submit">{{ '♥ Unlike' if p.i_like else '♡ Like' }}</button>
        <span class="meta">{{ p.like_count }} likes</span>
        <span class="meta">{{ p.comment_count }} comments</span>
      </form>
      {% endif %}
    </div>
    {% else %}
    <div class="card">No posts yet.</div>
    {% endfor %}
  </main>

  <aside class="col-side">
    <div class="card small">
      <div class="meta">Trending</div>
      {% if trending %}
      <div class="row" style="flex-wrap:wrap; gap:.4rem">
        {% for t in trending %}
        <a class="chip" href="{{ url_for('tag', tag=t['tag']) }}">#{{ t['tag'] }}</a>
        {% endfor %}
      </div>
      {% else %}
      <div class="meta">No trending tags yet.</div>
      {% endif %}
    </div>

    <div class="card small">
      <div class="meta">Who to follow</div>
      {% if who %}
      {% for u in who %}
      <div class="row" style="justify-content:space-between;width:100%">
        <a href="{{ url_for('profile', username=u['username']) }}">@{{ u['username'] }}</a>
        {% if me %}
        <form method="post" action="{{ url_for('follow', username=u['username']) }}">
          <button class="btn">Follow</button>
        </form>
        {% endif %}
      </div>
      {% endfor %}
      {% else %}
      <div class="meta">All caught up.</div>
      {% endif %}
    </div>
  </aside>
</div>
{% endblock %}
